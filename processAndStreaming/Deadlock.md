# Deadlock

**Deadlock** (взаимная блокировка) — ситуация, когда два и более потока нуждаются в ресурсах друг друга, которые сами и заблокировали.

### Пример сценария Deadlock

Представим, что у нас есть два потока (A и B) и два ресурса (R1 и R2). Deadlock может возникнуть в такой ситуации:

1. Поток A захватывает ресурс R1.
2. Поток B захватывает ресурс R2.
3. Поток A пытается захватить ресурс R2, но он уже занят потоком B.
4. Поток B пытается захватить ресурс R1, но он уже занят потоком A.

В результате ни один из потоков не может продолжить работу, потому что каждый ожидает освобождения ресурса, захваченного другим потоком.

### Условия возникновения Deadlock

Чтобы возникла взаимная блокировка, должны выполняться четыре условия:

1. **Взаимное исключение (Mutual Exclusion)** – Ресурсы не могут быть разделены, и каждый из них может быть занят только одним потоком.
2. **Удержание и ожидание (Hold and Wait)** – Поток, который уже удерживает один ресурс, ожидает доступ к другому ресурсу, при этом продолжая удерживать первый.
3. **Отсутствие принудительного освобождения (No Preemption)** – Ресурс, занятый потоком, не может быть принудительно изъят до завершения работы потока.
4. **Циклическое ожидание (Circular Wait)** – Существует цикл ожидания, когда поток A ожидает ресурс, занятый потоком B, поток B ожидает ресурс, занятый потоком C, и так далее, до тех пор, пока цикл не замкнется.

Если все четыре условия выполняются одновременно, может возникнуть deadlock.

### Методы предотвращения и устранения Deadlock

1. **Предотвращение Deadlock**:
   - Избегайте циклического ожидания, захватывая все необходимые ресурсы одновременно.
   - Вводите порядок для захвата ресурсов, чтобы избежать циклов.
   - Используйте тайм-ауты при захвате ресурсов, чтобы потоки могли освобождать ресурсы в случае долгого ожидания.

2. **Обнаружение и устранение Deadlock**:
   - Обнаружение deadlock-а с помощью специального мониторинга зависимостей между потоками и освобождение ресурсов при его возникновении.
   - Принудительное освобождение ресурсов или завершение одного из потоков для устранения блокировки.

Deadlock может быть сложным для обнаружения и устранения, особенно в больших системах. Поэтому важно проектировать многопоточные приложения с учетом возможных ситуаций deadlock и использовать соответствующие методы для предотвращения таких ситуаций.